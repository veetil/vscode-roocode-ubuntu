# Step 2: Docker Implementation - Dockerfile and Base Container Setup

## Objective

Create a Dockerfile and base container setup for the RooCode modular system. This includes:
- Selecting the appropriate base image
- Installing necessary dependencies
- Setting up the container structure
- Creating a basic entrypoint script

## Base Image Selection

We'll use Ubuntu 22.04 as the base image, as it provides:
- Long-term support
- Good compatibility with RooCode dependencies
- Wide availability of packages
- Stability and security

## Dependencies

The container will need the following dependencies:
- Git for version control
- Node.js and npm for RooCode
- Xvfb for virtual display
- VS Code for the RooCode CLI
- Various system dependencies for the above

## Container Structure

We'll set up the following directory structure in the container:
- `/app`: Application directory for scripts and configuration
- `/data`: Data directory for input and output files (mounted as a volume)
- `/home/ubuntu/LaunchRoo`: RooCode installation directory

## Dockerfile Implementation

```dockerfile
# Use Ubuntu 22.04 as the base image
FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV HOME=/home/ubuntu
ENV DISPLAY=:99

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    xvfb \
    libgtk-3-0 \
    libxss1 \
    libasound2 \
    libx11-xcb1 \
    libxkbfile1 \
    libsecret-1-0 \
    libnotify4 \
    xdg-utils \
    dbus \
    dbus-x11 \
    libgbm1 \
    libdrm2 \
    libxshmfence1 \
    libglu1-mesa \
    x11-apps \
    x11-xserver-utils \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js and npm
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Create ubuntu user
RUN useradd -m -d /home/ubuntu -s /bin/bash ubuntu \
    && mkdir -p /home/ubuntu/.config \
    && chown -R ubuntu:ubuntu /home/ubuntu

# Create application directories
RUN mkdir -p /app /data/input /data/output \
    && chown -R ubuntu:ubuntu /app /data

# Set working directory
WORKDIR /app

# Copy entrypoint script
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh

# Switch to ubuntu user
USER ubuntu

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
```

## Entrypoint Script Implementation

```bash
#!/bin/bash
# entrypoint.sh - Docker container entrypoint script

# Start Xvfb
Xvfb :99 -screen 0 1024x768x24 &
export DISPLAY=:99

# Wait for Xvfb to start
sleep 2

# Check if Xvfb is running
if ! xdpyinfo -display :99 >/dev/null 2>&1; then
  echo "Error: Xvfb failed to start"
  exit 1
fi

# Process inputs
if [ -z "${QUESTION}" ]; then
  echo "Error: QUESTION environment variable is required"
  exit 1
fi

if [ -z "${EXPT}" ]; then
  echo "Error: EXPT environment variable is required"
  exit 1
fi

# Print startup information
echo "RooCode Docker Container"
echo "========================"
echo "Question: ${QUESTION}"
echo "Experiment: ${EXPT}"
echo "Files: ${FILES}"
echo "Prompt: ${PROMPT}"
echo "========================"

# Placeholder for RooCode modular system
echo "RooCode modular system would run here"

# Exit with success
exit 0
```

## Docker Build Script

```bash
#!/bin/bash
# build-docker.sh - Build the RooCode Docker image

# Build the Docker image
docker build -t roocode-modular .

# Check if the build was successful
if [ $? -ne 0 ]; then
  echo "Error: Docker build failed"
  exit 1
fi

echo "Docker image built successfully: roocode-modular"
```

## Docker Run Script

```bash
#!/bin/bash
# run-docker.sh - Run the RooCode Docker container

# Check for required arguments
if [ $# -lt 2 ]; then
  echo "Usage: $0 <question> <experiment>"
  echo "Example: $0 \"How do I implement grep?\" grep"
  exit 1
fi

QUESTION="$1"
EXPT="$2"
FILES="${3:-}"
PROMPT="${4:-}"

# Create data directories if they don't exist
mkdir -p data/input data/output

# Run the Docker container
docker run --rm \
  -e QUESTION="${QUESTION}" \
  -e EXPT="${EXPT}" \
  -e FILES="${FILES}" \
  -e PROMPT="${PROMPT}" \
  -v "$(pwd)/data:/data" \
  roocode-modular

# Check if the container ran successfully
if [ $? -ne 0 ]; then
  echo "Error: Docker container failed"
  exit 1
fi

echo "Docker container ran successfully"
```

## Testing

We'll create a test script called `test-docker-base.sh` that:
1. Builds the Docker image
2. Runs the container with test inputs
3. Verifies that the container runs successfully
4. Checks that the entrypoint script processes inputs correctly

## Next Steps

In the next step, we'll implement the entrypoint script and input handling in more detail. This will include:
- Processing environment variables
- Handling file inputs
- Validating inputs
- Setting up the container environment for RooCode

We'll build on the base container setup implemented in this step.