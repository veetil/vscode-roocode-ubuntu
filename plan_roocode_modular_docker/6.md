# Step 6: Docker Implementation - Output Handling, Result Reporting, and Comprehensive Testing

## Objective

Implement output handling, result reporting, and comprehensive testing for the RooCode Docker container. This includes:
- Capturing and processing the output of the RooCode workflow
- Generating detailed reports
- Handling errors and edge cases
- Providing clear feedback to the user
- Creating comprehensive tests and documentation

## Output Handling and Result Reporting Design

### Output Processing

We'll implement functions to:
1. Capture the output of the RooCode workflow
2. Extract relevant information (test results, branch name, etc.)
3. Format the output for easy consumption

### Result Reporting

We'll implement functions to:
1. Generate detailed reports
2. Save reports to output files
3. Print summary information to the console

### Error Handling

We'll implement functions to:
1. Detect and handle errors
2. Provide clear error messages
3. Save error information to output files

## Implementation

We'll extend the entrypoint script with output handling and result reporting functions:

```bash
# Function to process RooCode output
function process_roocode_output {
  log "Processing RooCode output..."
  
  local output_file="${OUTPUT_DIR}/roocode-output.log"
  local report_file="${OUTPUT_DIR}/report.md"
  
  # Check if the output file exists
  if [ ! -f "${output_file}" ]; then
    error "RooCode output file does not exist"
    exit 1
  fi
  
  # Extract test results
  local tests_passed=false
  if grep -q "All tests passed" "${output_file}"; then
    tests_passed=true
  fi
  
  # Extract branch name
  local branch_name=$(grep -o "Branch: [a-zA-Z0-9_-]*" "${output_file}" | cut -d' ' -f2)
  
  # If branch name wasn't found, use a default
  if [ -z "${branch_name}" ]; then
    branch_name="unknown"
  fi
  
  # Generate report
  cat > "${report_file}" << EOF
# RooCode Execution Report

## Summary

- **Question**: ${QUESTION}
- **Experiment**: ${EXPT}
- **Tests Passed**: ${tests_passed}
- **Branch Name**: ${branch_name}

## Details

EOF
  
  # Add test details to the report
  if grep -q "Test Results:" "${output_file}"; then
    echo "### Test Results" >> "${report_file}"
    echo "" >> "${report_file}"
    echo "\`\`\`" >> "${report_file}"
    grep -A 10 "Test Results:" "${output_file}" >> "${report_file}"
    echo "\`\`\`" >> "${report_file}"
    echo "" >> "${report_file}"
  fi
  
  # Add error details to the report if tests failed
  if [ "${tests_passed}" = "false" ]; then
    echo "### Errors" >> "${report_file}"
    echo "" >> "${report_file}"
    echo "\`\`\`" >> "${report_file}"
    grep -A 10 "Error:" "${output_file}" >> "${report_file}" || true
    echo "\`\`\`" >> "${report_file}"
    echo "" >> "${report_file}"
  fi
  
  # Add full output to the report
  echo "### Full Output" >> "${report_file}"
  echo "" >> "${report_file}"
  echo "\`\`\`" >> "${report_file}"
  cat "${output_file}" >> "${report_file}"
  echo "\`\`\`" >> "${report_file}"
  
  # Write results to a simple text file for easy parsing
  echo "tests_passed=${tests_passed}" > "${OUTPUT_DIR}/results.txt"
  echo "branch_name=${branch_name}" >> "${OUTPUT_DIR}/results.txt"
  
  log "RooCode output processed successfully"
  
  # Return test results
  if [ "${tests_passed}" = "true" ]; then
    return 0
  else
    return 1
  fi
}

# Function to print summary
function print_summary {
  local tests_passed=$1
  local branch_name=$2
  
  echo ""
  echo "========================================"
  echo "RooCode Execution Summary"
  echo "========================================"
  echo "Question: ${QUESTION}"
  echo "Experiment: ${EXPT}"
  echo "Tests Passed: ${tests_passed}"
  echo "Branch Name: ${branch_name}"
  echo "========================================"
  echo ""
  
  if [ "${tests_passed}" = "true" ]; then
    echo "✅ All tests passed!"
  else
    echo "❌ Some tests failed. See the report for details."
  fi
  
  echo ""
  echo "Report saved to: ${OUTPUT_DIR}/report.md"
  echo ""
}
```

We'll update the `run_roocode_workflow` function to use these new functions:

```bash
# Function to run RooCode workflow
function run_roocode_workflow {
  log "Running RooCode workflow..."
  
  # Change to the LaunchRoo directory
  cd "${LAUNCH_ROO_DIR}"
  
  # Create a unique branch name
  local branch_name="roocode-${EXPT}-$(date +%Y%m%d%H%M%S)"
  
  # Run the RooCode CLI
  log "Executing RooCode CLI..."
  ./run-cli-with-xvfb.sh python "${EXPT}" > "${OUTPUT_DIR}/roocode-output.log" 2>&1
  
  # Check if the command was successful
  if [ $? -ne 0 ]; then
    error "RooCode CLI execution failed"
    cat "${OUTPUT_DIR}/roocode-output.log" >&2
    
    # Process the output even if the command failed
    process_roocode_output
    
    # Print summary
    print_summary "false" "${branch_name}"
    
    exit 1
  fi
  
  # Process the output
  local tests_passed=false
  if process_roocode_output; then
    tests_passed=true
  fi
  
  # Extract branch name from the results file
  local actual_branch_name=$(grep "branch_name=" "${OUTPUT_DIR}/results.txt" | cut -d'=' -f2)
  
  # Print summary
  print_summary "${tests_passed}" "${actual_branch_name}"
  
  log "RooCode workflow completed"
  
  # Return test results
  if [ "${tests_passed}" = "true" ]; then
    return 0
  else
    return 1
  fi
}
```

We'll update the `main` function to handle the return value from `run_roocode_workflow`:

```bash
# Main function
function main {
  log "Starting RooCode Docker container..."
  
  # Start Xvfb
  start_xvfb
  
  # Configure git
  configure_git
  
  # Install RooCode (if not already installed)
  install_roocode
  
  # Configure RooCode
  configure_roocode
  
  # Validate inputs
  validate_inputs
  
  # Prepare environment
  prepare_environment
  
  # Process inputs
  process_question
  process_prompt
  process_files
  
  # Handle git operations
  handle_git_operations
  
  # Run RooCode workflow
  if run_roocode_workflow; then
    log "RooCode Docker container completed successfully"
    exit 0
  else
    log "RooCode Docker container completed with errors"
    exit 1
  fi
}
```

## Comprehensive Testing

We'll create a comprehensive test suite for the Docker implementation:

### Test Script: `test-docker-all.sh`

```bash
#!/bin/bash
# test-docker-all.sh - Run all tests for the RooCode Docker implementation

# Function to run a test script and report results
function run_test {
  local script="$1"
  local name="$2"
  
  echo "Running ${name} tests..."
  
  # Run the test script
  ./${script}
  
  # Check the exit code
  if [ $? -eq 0 ]; then
    echo "${name} tests: PASSED"
    return 0
  else
    echo "${name} tests: FAILED"
    return 1
  fi
}

# Main function
function main {
  echo "Running all tests for the RooCode Docker implementation..."
  echo ""
  
  local failed=0
  
  # Run each test script
  run_test "test-docker-base.sh" "Base Container" || ((failed++))
  run_test "test-entrypoint.sh" "Entrypoint Script" || ((failed++))
  run_test "test-roocode-installation.sh" "RooCode Installation" || ((failed++))
  run_test "test-modular-system.sh" "Modular System" || ((failed++))
  run_test "test-output-handling.sh" "Output Handling" || ((failed++))
  run_test "test-end-to-end.sh" "End-to-End" || ((failed++))
  
  echo ""
  if [ ${failed} -eq 0 ]; then
    echo "All tests passed!"
    exit 0
  else
    echo "${failed} test(s) failed."
    exit 1
  fi
}

# Execute main function
main
```

### Test Script: `test-output-handling.sh`

```bash
#!/bin/bash
# test-output-handling.sh - Test output handling and result reporting

# Build the Docker image
docker build -t roocode-modular .

# Check if the build was successful
if [ $? -ne 0 ]; then
  echo "Error: Docker build failed"
  exit 1
fi

# Create test input files
mkdir -p test/input test/output
echo "Test question" > test/input/question.txt

# Create a mock RooCode output file
cat > test/input/mock-output.log << EOF
Starting RooCode...
Loading experiment: test-expt
Running tests...
Test Results:
All tests passed!
Branch: test-branch-123
EOF

# Run the Docker container with a mock RooCode workflow
docker run --rm \
  -e QUESTION="Test question" \
  -e EXPT="test-expt" \
  -e MOCK_OUTPUT="true" \
  -v "$(pwd)/test/input:/data/input" \
  -v "$(pwd)/test/output:/data/output" \
  roocode-modular

# Check if the container ran successfully
if [ $? -ne 0 ]; then
  echo "Error: Docker container failed"
  exit 1
fi

# Check if the output files exist
if [ ! -f "test/output/report.md" ]; then
  echo "Error: report.md was not created"
  exit 1
fi

if [ ! -f "test/output/results.txt" ]; then
  echo "Error: results.txt was not created"
  exit 1
fi

# Check if the test results were extracted correctly
if ! grep -q "tests_passed=true" "test/output/results.txt"; then
  echo "Error: Test results were not extracted correctly"
  exit 1
fi

# Check if the branch name was extracted correctly
if ! grep -q "branch_name=test-branch-123" "test/output/results.txt"; then
  echo "Error: Branch name was not extracted correctly"
  exit 1
fi

echo "Output handling test passed!"
```

### Test Script: `test-end-to-end.sh`

```bash
#!/bin/bash
# test-end-to-end.sh - Test the entire Docker implementation end-to-end

# Build the Docker image
docker build -t roocode-modular .

# Check if the build was successful
if [ $? -ne 0 ]; then
  echo "Error: Docker build failed"
  exit 1
fi

# Create test input files
mkdir -p test/input test/output
echo "Test question" > test/input/question.txt
echo "Test prompt" > test/input/prompt.txt
echo "print('Hello, world!')" > test/input/hello.py

# Run the Docker container
docker run --rm \
  -e QUESTION="Test question" \
  -e EXPT="test-expt" \
  -e FILES="hello.py:,prompt.txt:" \
  -e PROMPT="$(cat test/input/prompt.txt)" \
  -v "$(pwd)/test/input:/data/input" \
  -v "$(pwd)/test/output:/data/output" \
  roocode-modular

# Check if the container ran successfully
if [ $? -ne 0 ]; then
  echo "Error: Docker container failed"
  exit 1
fi

# Check if the output files exist
if [ ! -f "test/output/report.md" ]; then
  echo "Error: report.md was not created"
  exit 1
fi

if [ ! -f "test/output/results.txt" ]; then
  echo "Error: results.txt was not created"
  exit 1
fi

echo "End-to-end test passed!"
```

## Documentation

We'll create comprehensive documentation for the Docker implementation:

### `README.md`

```markdown
# RooCode Docker Implementation

A Docker implementation of the RooCode modular system.

## Features

- Run RooCode in a containerized environment
- Accept inputs as described in the modular implementation
- Execute the RooCode workflow within the container
- Report results back to the host system

## Prerequisites

- Docker
- Bash

## Installation

1. Clone this repository:
   ```bash
   git clone https://github.com/example/roocode-docker.git
   cd roocode-docker
   ```

2. Build the Docker image:
   ```bash
   docker build -t roocode-modular .
   ```

## Usage

```bash
docker run --rm \
  -e QUESTION="Your question here" \
  -e EXPT="experiment_folder" \
  -e FILES="file1.txt:,file2.txt:docs" \
  -e PROMPT="Optional prompt text" \
  -v "$(pwd)/input:/data/input" \
  -v "$(pwd)/output:/data/output" \
  roocode-modular
```

### Environment Variables

- `QUESTION`: The user question to save to question.md (required)
- `EXPT`: The experiment folder name (required)
- `FILES`: A comma-separated list of source:destination file pairs (optional)
- `PROMPT`: The prompt text to save to outline.md (optional)
- `DEBUG`: Enable debug mode if set to "true" (optional)

### Volumes

- `/data/input`: Input files directory
- `/data/output`: Output files directory

### Output Files

- `report.md`: Detailed report of the RooCode execution
- `results.txt`: Simple text file with key-value pairs for easy parsing
- `roocode-output.log`: Raw output from the RooCode CLI

## Examples

### Basic Example

```bash
docker run --rm \
  -e QUESTION="How do I implement grep?" \
  -e EXPT="grep" \
  -v "$(pwd)/input:/data/input" \
  -v "$(pwd)/output:/data/output" \
  roocode-modular
```

### Example with Files

```bash
docker run --rm \
  -e QUESTION="How do I implement grep?" \
  -e EXPT="grep" \
  -e FILES="file1.txt:,file2.txt:docs" \
  -v "$(pwd)/input:/data/input" \
  -v "$(pwd)/output:/data/output" \
  roocode-modular
```

### Example with Prompt

```bash
docker run --rm \
  -e QUESTION="How do I implement grep?" \
  -e EXPT="grep" \
  -e PROMPT="Implement grep with support for regular expressions" \
  -v "$(pwd)/input:/data/input" \
  -v "$(pwd)/output:/data/output" \
  roocode-modular
```

## Testing

Run the test suite:

```bash
./test-docker-all.sh
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.
```

## Next Steps

With the completion of this step, we'll have a fully functional Docker implementation of the RooCode modular system. The next steps would be:

1. **Integration Testing**: Test the Docker implementation with real-world scenarios
2. **Performance Optimization**: Optimize the Docker image for size and performance
3. **CI/CD Integration**: Set up continuous integration and deployment
4. **User Documentation**: Create comprehensive user documentation
5. **Maintenance**: Establish a maintenance plan for updates and bug fixes

These steps are beyond the scope of the current plan but would be important for a production-ready implementation.