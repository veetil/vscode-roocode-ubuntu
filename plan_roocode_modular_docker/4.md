# Step 4: Docker Implementation - RooCode Installation and Configuration

## Objective

Implement the RooCode installation and configuration within the Docker container. This includes:
- Cloning the RooCode repository
- Installing dependencies
- Configuring RooCode for use within the container
- Setting up the virtual display for RooCode

## RooCode Installation Design

### Repository Setup

We'll implement a function to:
1. Clone the RooCode repository
2. Configure git for use within the container
3. Handle potential errors

### Dependency Installation

We'll implement a function to:
1. Install Node.js dependencies
2. Install VS Code
3. Install other required dependencies
4. Handle potential errors

### RooCode Configuration

We'll implement a function to:
1. Configure RooCode for use within the container
2. Set up environment variables
3. Handle potential errors

## Implementation

We'll extend the Dockerfile to include RooCode installation:

```dockerfile
# Use Ubuntu 22.04 as the base image
FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV HOME=/home/ubuntu
ENV DISPLAY=:99
ENV ROOCODE_DIR=/home/ubuntu/LaunchRoo

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    xvfb \
    libgtk-3-0 \
    libxss1 \
    libasound2 \
    libx11-xcb1 \
    libxkbfile1 \
    libsecret-1-0 \
    libnotify4 \
    xdg-utils \
    dbus \
    dbus-x11 \
    libgbm1 \
    libdrm2 \
    libxshmfence1 \
    libglu1-mesa \
    x11-apps \
    x11-xserver-utils \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js and npm
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Install VS Code
RUN wget -q https://update.code.visualstudio.com/latest/linux-deb-x64/stable -O /tmp/vscode.deb \
    && dpkg -i /tmp/vscode.deb || apt-get -f install -y \
    && rm /tmp/vscode.deb

# Create ubuntu user
RUN useradd -m -d /home/ubuntu -s /bin/bash ubuntu \
    && mkdir -p /home/ubuntu/.config \
    && chown -R ubuntu:ubuntu /home/ubuntu

# Create application directories
RUN mkdir -p /app /data/input /data/output \
    && chown -R ubuntu:ubuntu /app /data

# Switch to ubuntu user
USER ubuntu

# Clone RooCode repository
RUN git clone https://github.com/example/LaunchRoo.git ${ROOCODE_DIR} \
    && cd ${ROOCODE_DIR} \
    && npm install

# Set working directory
WORKDIR /app

# Copy entrypoint script
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
```

We'll extend the entrypoint script with RooCode installation and configuration functions:

```bash
# Function to configure git
function configure_git {
  log "Configuring git..."
  
  # Set git configuration
  git config --global user.name "RooCode Docker"
  git config --global user.email "roocode-docker@example.com"
  
  log "Git configured successfully"
}

# Function to install RooCode
function install_roocode {
  log "Installing RooCode..."
  
  # Check if RooCode is already installed
  if [ -d "${LAUNCH_ROO_DIR}" ]; then
    log "RooCode is already installed"
    return 0
  fi
  
  # Clone RooCode repository
  git clone https://github.com/example/LaunchRoo.git "${LAUNCH_ROO_DIR}"
  
  # Check if the clone was successful
  if [ $? -ne 0 ]; then
    error "Failed to clone RooCode repository"
    exit 1
  fi
  
  # Install dependencies
  cd "${LAUNCH_ROO_DIR}"
  npm install
  
  # Check if the installation was successful
  if [ $? -ne 0 ]; then
    error "Failed to install RooCode dependencies"
    exit 1
  fi
  
  log "RooCode installed successfully"
}

# Function to configure RooCode
function configure_roocode {
  log "Configuring RooCode..."
  
  # Create run-cli-with-xvfb.sh script
  cat > "${LAUNCH_ROO_DIR}/run-cli-with-xvfb.sh" << 'EOF'
#!/bin/bash
# run-cli-with-xvfb.sh - Run RooCode CLI with virtual display

# Check if Xvfb is already running
if ! xdpyinfo -display :99 >/dev/null 2>&1; then
  echo "Starting Xvfb..."
  Xvfb :99 -screen 0 1024x768x24 &
  export DISPLAY=:99
  sleep 2
fi

# Run RooCode CLI
cd "$(dirname "$0")"
node ./cli.js "$@"
EOF
  
  # Make the script executable
  chmod +x "${LAUNCH_ROO_DIR}/run-cli-with-xvfb.sh"
  
  log "RooCode configured successfully"
}
```

We'll update the `main` function to call these new functions:

```bash
# Main function
function main {
  log "Starting RooCode Docker container..."
  
  # Start Xvfb
  start_xvfb
  
  # Configure git
  configure_git
  
  # Install RooCode (if not already installed)
  install_roocode
  
  # Configure RooCode
  configure_roocode
  
  # Validate inputs
  validate_inputs
  
  # Prepare environment
  prepare_environment
  
  # Process inputs
  process_question
  process_prompt
  process_files
  
  # Print summary
  log "Input processing completed successfully"
  log "Question: ${QUESTION}"
  log "Experiment: ${EXPT}"
  log "Files: ${FILES}"
  log "Prompt: ${PROMPT}"
  
  # Placeholder for RooCode execution
  log "RooCode execution would happen here"
  
  log "RooCode Docker container completed successfully"
}
```

## Testing

We'll create a test script called `test-roocode-installation.sh` that:
1. Builds the Docker image with RooCode installation
2. Runs the container with test inputs
3. Verifies that RooCode is installed and configured correctly
4. Tests running a simple RooCode command

```bash
#!/bin/bash
# test-roocode-installation.sh - Test RooCode installation

# Build the Docker image
docker build -t roocode-modular .

# Check if the build was successful
if [ $? -ne 0 ]; then
  echo "Error: Docker build failed"
  exit 1
fi

# Create test input files
mkdir -p test/input
echo "Test question" > test/input/question.txt

# Run the Docker container
docker run --rm \
  -e QUESTION="Test question" \
  -e EXPT="test-expt" \
  -v "$(pwd)/test/input:/data/input" \
  -v "$(pwd)/test/output:/data/output" \
  roocode-modular

# Check if the container ran successfully
if [ $? -ne 0 ]; then
  echo "Error: Docker container failed"
  exit 1
fi

echo "RooCode installation test passed!"
```

## Next Steps

In the next step, we'll implement the modular system within the container. This will include:
- Integrating the modular system from the previous plan
- Adapting it for use within the Docker container
- Handling git operations within the container
- Running the RooCode workflow

We'll build on the RooCode installation and configuration implemented in this step.