# Step 4: Git Operations

## Objective

Implement the git operations component of the RooCode modular system. This component will:
- Remove the remote for /home/ubuntu/LaunchRoo/evals if it exists
- Keep the git checkout main operation
- Update the local main branch with created files
- Create a new branch during workflow execution
- Commit changes to the new branch

## Git Operations Design

### Remote Management

We'll implement a function to:
1. Check if a remote exists for the evals repository
2. If it exists, remove it
3. Handle potential errors

### Branch Management

We'll implement functions to:
1. Checkout the main branch
2. Update the local main branch with created files
3. Create a new branch for the workflow execution
4. Commit changes to the new branch
5. Handle potential errors

### Branch Name Tracking

We'll implement a mechanism to:
1. Generate a unique branch name for the workflow execution
2. Store the branch name for later reporting
3. Handle potential errors

## Implementation

We'll extend the `roocode-modular.sh` script with the following functions:

```bash
# Function to remove remote if it exists
function remove_remote {
  echo "Checking for remote in evals repository..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Check if a remote exists
  if git remote -v | grep -q "github.com/cte/eval"; then
    echo "Remote found, removing..."
    git remote remove origin
    
    # Check if the remote was removed successfully
    if [ $? -ne 0 ]; then
      echo "Error: Failed to remove remote"
      exit 1
    fi
    
    echo "Remote removed successfully."
  else
    echo "No remote found, skipping removal."
  fi
}

# Function to checkout main branch
function checkout_main {
  echo "Checking out main branch..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Checkout the main branch
  git checkout main
  
  # Check if the checkout was successful
  if [ $? -ne 0 ]; then
    echo "Error: Failed to checkout main branch"
    exit 1
  fi
  
  echo "Main branch checked out successfully."
}

# Function to update main branch with created files
function update_main {
  echo "Updating main branch with created files..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Add all changes
  git add .
  
  # Check if there are any changes to commit
  if git diff --cached --quiet; then
    echo "No changes to commit, skipping update."
    return 0
  fi
  
  # Commit the changes
  git commit -m "Add files for experiment: ${EXPT}"
  
  # Check if the commit was successful
  if [ $? -ne 0 ]; then
    echo "Error: Failed to commit changes to main branch"
    exit 1
  fi
  
  echo "Main branch updated successfully."
}

# Function to create a new branch for workflow execution
function create_workflow_branch {
  echo "Creating new branch for workflow execution..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Generate a unique branch name
  BRANCH_NAME="workflow-${EXPT}-$(date +%Y%m%d-%H%M%S)"
  
  # Create the branch
  git checkout -b "${BRANCH_NAME}"
  
  # Check if the branch creation was successful
  if [ $? -ne 0 ]; then
    echo "Error: Failed to create new branch"
    exit 1
  fi
  
  # Store the branch name for later reporting
  echo "${BRANCH_NAME}" > "/tmp/roocode-branch-name.txt"
  
  echo "New branch created successfully: ${BRANCH_NAME}"
}

# Function to commit changes to the workflow branch
function commit_workflow_changes {
  echo "Committing changes to workflow branch..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Add all changes
  git add .
  
  # Check if there are any changes to commit
  if git diff --cached --quiet; then
    echo "No changes to commit, skipping commit."
    return 0
  fi
  
  # Commit the changes
  git commit -m "Workflow execution results for experiment: ${EXPT}"
  
  # Check if the commit was successful
  if [ $? -ne 0 ]; then
    echo "Error: Failed to commit changes to workflow branch"
    exit 1
  fi
  
  echo "Changes committed successfully to workflow branch."
}

# Function to perform all git operations
function manage_git {
  remove_remote
  checkout_main
  update_main
  create_workflow_branch
  # commit_workflow_changes will be called after workflow execution
}
```

We'll update the `main` function to call the new `manage_git` function:

```bash
# Main function
function main {
  parse_arguments "$@"
  validate_inputs
  manage_experiment_folder
  save_question
  save_prompt
  copy_files
  manage_git
  
  # Placeholder for future components
  echo "Git operations completed successfully."
}
```

## Testing

We'll create a test script called `test-git-operations.sh` that:
1. Tests removing a remote if it exists
2. Tests checking out the main branch
3. Tests updating the main branch with created files
4. Tests creating a new branch for workflow execution
5. Tests committing changes to the workflow branch
6. Verifies that all git operations are performed correctly

## Next Steps

In the next step, we'll implement the workflow execution and result reporting components, which will:
- Run the RooCode CLI with the virtual display
- Capture and report test results
- Report the name of the new branch created

We'll build on the git operations component implemented in this step.