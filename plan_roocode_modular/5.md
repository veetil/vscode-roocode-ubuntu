# Step 5: Workflow Execution and Result Reporting

## Objective

Implement the workflow execution and result reporting components of the RooCode modular system. These components will:
- Run the RooCode CLI with the virtual display
- Capture and report test results
- Report the name of the new branch created
- Handle potential errors

## Workflow Execution Design

### CLI Execution

We'll implement a function to:
1. Run the RooCode CLI with the virtual display
2. Pass the experiment folder as an argument
3. Capture the output for later analysis
4. Handle potential errors

### Test Result Capture

We'll implement a function to:
1. Parse the CLI output to determine if tests passed
2. Store the test results for later reporting
3. Handle potential errors

### Branch Name Reporting

We'll implement a function to:
1. Retrieve the branch name stored during git operations
2. Include it in the final report
3. Handle potential errors

## Implementation

We'll extend the `roocode-modular.sh` script with the following functions:

```bash
# Function to run the RooCode CLI with virtual display
function run_workflow {
  echo "Running RooCode CLI with virtual display..."
  
  # Change to the LaunchRoo directory
  cd "/home/ubuntu/LaunchRoo"
  
  # Run the CLI with the virtual display
  ./run-cli-with-xvfb.sh python "${EXPT}" > "/tmp/roocode-output.log" 2>&1
  
  # Check if the CLI execution was successful
  CLI_EXIT_CODE=$?
  if [ ${CLI_EXIT_CODE} -ne 0 ]; then
    echo "Error: RooCode CLI execution failed with exit code ${CLI_EXIT_CODE}"
    echo "See /tmp/roocode-output.log for details"
    exit 1
  fi
  
  echo "RooCode CLI execution completed."
}

# Function to capture test results
function capture_test_results {
  echo "Capturing test results..."
  
  # Parse the CLI output to determine if tests passed
  if grep -q "All tests passed" "/tmp/roocode-output.log"; then
    TESTS_PASSED=true
    echo "All tests passed."
  else
    TESTS_PASSED=false
    echo "Some tests failed or could not be determined."
  fi
  
  # Store the test results for later reporting
  if [ "${TESTS_PASSED}" = true ]; then
    echo "true" > "/tmp/roocode-tests-passed.txt"
  else
    echo "false" > "/tmp/roocode-tests-passed.txt"
  fi
}

# Function to commit workflow changes
function commit_workflow_changes {
  echo "Committing workflow changes..."
  
  # Change to the evals directory
  cd "${EVALS_DIR}"
  
  # Add all changes
  git add .
  
  # Check if there are any changes to commit
  if git diff --cached --quiet; then
    echo "No changes to commit, skipping commit."
    return 0
  fi
  
  # Commit the changes
  git commit -m "Workflow execution results for experiment: ${EXPT}"
  
  # Check if the commit was successful
  if [ $? -ne 0 ]; then
    echo "Error: Failed to commit changes to workflow branch"
    exit 1
  fi
  
  echo "Changes committed successfully to workflow branch."
}

# Function to report results
function report_results {
  echo ""
  echo "========================================"
  echo "RooCode Modular Workflow Results"
  echo "========================================"
  echo ""
  
  # Report test results
  if [ -f "/tmp/roocode-tests-passed.txt" ]; then
    TESTS_PASSED=$(cat "/tmp/roocode-tests-passed.txt")
    if [ "${TESTS_PASSED}" = "true" ]; then
      echo "Tests: PASSED"
    else
      echo "Tests: FAILED"
    fi
  else
    echo "Tests: UNKNOWN"
  fi
  
  # Report branch name
  if [ -f "/tmp/roocode-branch-name.txt" ]; then
    BRANCH_NAME=$(cat "/tmp/roocode-branch-name.txt")
    echo "Branch: ${BRANCH_NAME}"
  else
    echo "Branch: UNKNOWN"
  fi
  
  echo ""
  echo "Experiment: ${EXPT}"
  echo "Question file: ${PYTHON_DIR}/${EXPT}/question.md"
  if [ -n "${PROMPT}" ]; then
    echo "Outline file: ${PYTHON_DIR}/${EXPT}/outline.md"
  fi
  
  echo ""
  echo "========================================"
}

# Function to clean up temporary files
function cleanup {
  echo "Cleaning up temporary files..."
  
  rm -f "/tmp/roocode-branch-name.txt"
  rm -f "/tmp/roocode-tests-passed.txt"
  rm -f "/tmp/roocode-output.log"
  
  echo "Cleanup completed."
}
```

We'll update the `main` function to call these new functions:

```bash
# Main function
function main {
  parse_arguments "$@"
  validate_inputs
  manage_experiment_folder
  save_question
  save_prompt
  copy_files
  manage_git
  run_workflow
  capture_test_results
  commit_workflow_changes
  report_results
  cleanup
  
  echo "RooCode modular workflow completed successfully."
}
```

## Testing

We'll create a test script called `test-workflow-execution.sh` that:
1. Tests running the RooCode CLI with various experiment folders
2. Tests capturing test results from various CLI outputs
3. Tests reporting results with various test outcomes and branch names
4. Verifies that all components work correctly together

## Next Steps

In the final step, we'll create comprehensive tests and documentation for the entire system. This will include:
- End-to-end tests for the entire workflow
- Documentation for users and developers
- Examples of common use cases
- Troubleshooting guide

We'll build on all the components implemented in previous steps to create a complete, well-tested, and well-documented system.